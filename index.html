<!--
    Web version released under the WTFPL by Esaj from forum.electricunicycle.org
    Original Java version by Jonathan Vasquez (fearedbliss) <jvasquez1011@gmail.com>
-->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>King Song v4 Key Generator</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/generator.css" rel="stylesheet">
    </head>

<body>
    <div class="generator">
        <h3>King Song v4 Key Generator</h3>
        <label for="isn" class="sr-only">ISN</label>
        <input type="text" id="isn" class="form-control" placeholder="11:22:33:44:55:66" required autofocus>
        <label for="answer" class="sr-only">Answer</label>
        <input type="text" id="answer" class="form-control" placeholder="Unlock Code" readonly>
        <button class="btn btn-lg btn-primary btn-block" type="submit" onclick="calculate()">Unlock</button>
        <center><a href="https://github.com/fearedbliss/KingSongISNKeyGenerator" class="btn btn-link">Java Version of Key Generator</a></center>
    </div>

<script type="text/javascript">
function calculate()
{
    var isnVal;
    var i;
    var code;
    var codeVal;
    var codeTemp;
    var isn = document.getElementById("isn").value.trim();

    try
    {
        isnVal = isn.split(":");

        if (isnVal.length == 1) {
            //No colons, split by 2 characters
            if (isn.length != 12) {
                throw false;
            }

            isnVal = [];
            for (i = 0; i < 6; i++) {
                isnVal[i] = isn.slice(i*2, i*2+2);
            }
        }

        if(isnVal.length != 6) {
            throw false;
        }

        code = [];
        code[1] = 0;
        code[3] = 0;

        code[0] = 255 - parseInt(isnVal[0], 16);
        code[2] = 255 - parseInt(isnVal[2], 16);
        code[4] = 255 - parseInt(isnVal[4], 16);

        //Calculate checksum from other values
        code[5] = ((code[0] + code[1] + code[2] + code[3] + code[4]) & 0xFF);

        codeVal = "";
        for(i = 0; i < 6; i++) {
            codeTemp = code[i].toString(16);
            if(codeTemp.length < 2) {
                codeTemp = "0" + codeTemp;
            }
            codeVal += codeTemp;
            if(i < 5) {
                codeVal += ":";
            }
        }

        document.getElementById("answer").value = codeVal.toUpperCase();
    }
    catch (ex) {
        document.getElementById("answer").value = "There was an error processing your ISN.";
    }
};
</script>
</body>
</html>
